from flask import Flask, request, jsonify
from flask_cors  import CORS
from openai      import OpenAI        
import pandas as pd, random, re
from typing import Optional
import os
from flask import send_from_directory

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ×”×’×“×¨×•×ª ×‘×¡×™×¡  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
app = Flask(__name__)
CORS(app)

links_df = pd.read_csv("calming_links_large_cleaned.csv").fillna("")

CATEGORIES = {
    "××“×™×˜×¦×™×”":     "××“×™×˜×¦×™×”",
    "× ×©×™××•×ª":      "× ×©×™××•×ª",
    "×”×¤×’×ª ××ª×—×™×": "×”×¤×’×ª ××ª×—×™×"
}


DANGER_WORDS = {
    "×œ×”×ª××‘×“",
    "××•×‘×“× ×™",
    "××•×‘×“× ×•×ª",
    "×œ× ×¨×•×¦×” ×œ×—×™×•×ª",
    "×œ× ×©×•×•×” ×œ×—×™×•×ª",
    "×¨×•×¦×” ×œ××•×ª",
    "×× ×™ ×¨×•×¦×” ×œ××•×ª",
    "×‘× ×œ×™ ×œ××•×ª",
    "×œ× ×¨×•×¦×” ×œ×”××©×™×š",
    "×œ××•×ª",
    "×”××•×•×ª ×§×•×¨×¥ ×œ×™",
    "×œ× × ×©××¨ ×œ×™ ×›×•×—",
    "×“×™ ×œ×—×™×™×",
    "×©×™××•×ª ×”×›×œ",
    "×“×™ ×œ×™",
    "×—×™×™ ×œ× ×©×•×•×™×",
    "×× ×™ ×—×¡×¨ ×¢×¨×š",
    "×× ×™ ×—×¡×¨×ª ×¢×¨×š",
    "×”×—×™×™× ×—×¡×¨×™ ×˜×¢×"
}

NON_EMO_KEYWORDS = {
    # ×™×“×¢ ×›×œ×œ×™
    "×”×™×¡×˜×•×¨×™×”", "×‘×™×•×’×¨×¤×™×”", "×’××•×’×¨×¤×™×”", "××™×©×™× ××¤×•×¨×¡××™×",
    "××“×™× ×•×ª", "×¢×¨×™×", "×©×¤×•×ª", "×“×ª×•×ª", "×¤×™×œ×•×¡×•×¤×™×”",

    # ××§×˜×•××œ×™×” ×•×¤×•×œ×™×˜×™×§×”
    "×‘×—×™×¨×•×ª", "×¤×•×œ×™×˜×™×§×”", "×××©×œ×”", "×©×¨×™×", "×—×“×©×•×ª", "××™×¨×•×¢×™×",

    # ×©××œ×•×ª ×˜×¨×™×•×•×™×”
    "××™ ×”×™×”", "××ª×™", "×›××”", "××™×š ×§×•×¨××™×", "××” ×–×”", "×œ××”", "××™ ×”××¦×™×",

    # ××“×¢ ×•×˜×›× ×•×œ×•×’×™×”
    "×¤×™×–×™×§×”", "×›×™××™×”", "××ª××˜×™×§×”", "××¡×˜×¨×•× ×•××™×”", "××“×¢", "×ª×›× ×•×ª", "×§×•×“", "×‘×™× ×” ××œ××›×•×ª×™×ª",

    # ×ª×¨×‘×•×ª, ×¤× ××™ ×•×‘×™×“×•×¨
    "×¡×“×¨×”", "×¡×¨×˜", "× ×˜×¤×œ×™×§×¡", "×©×—×§×Ÿ", "×–××¨", "×©×™×¨", "××•×–×™×§×”", "×§×œ×™×¤", "×§×•×œ× ×•×¢", "×˜×œ×•×•×™×–×™×”",

    # ×¡×¤×•×¨×˜
    "×›×“×•×¨×’×œ", "×›×“×•×¨×¡×œ", "×©×—×§×Ÿ ×›×“×•×¨×’×œ", "×œ×™×’×ª ×”××œ×•×¤×•×ª", "××œ×™×¤×•×ª",

    # ××•×›×œ ×•××ª×›×•× ×™×
    "××ª×›×•×Ÿ", "××•×›×œ", "××¡×¢×“×”", "×‘×™×©×•×œ", "××ª×•×§×™×", "×§×™× ×•×—×™×", "××™×š ××›×™× ×™×",

    # ×›×œ×›×œ×” ×•×¦×¨×›× ×•×ª
    "×›××” ×¢×•×œ×”", "××—×™×¨", "×§× ×™×™×”", "××›×™×¨×”", "×”× ×—×•×ª", "××‘×¦×¢", "××××–×•×Ÿ",

    # ×ª×™×™×¨×•×ª ×•×ª×—×‘×•×¨×”
    "×˜×™×¡×”", "××œ×•×Ÿ", "×˜×™×•×œ", "×—×•×¤×©×”", "× ×¡×™×¢×”", "×¨×›×‘", "×ª×—×‘×•×¨×”",

    # × ×•×©××™× ×¢×¡×§×™×™× ×•×˜×›× ×™×™×
    "×¡×˜××¨×˜××¤", "××•×¦×¨", "×¤×™×ª×•×—", "××›×™×¨×•×ª", "×©×™×•×•×§", "× ×™×”×•×œ ×¤×¨×•×™×§×˜×™×"
}

LINK_REQUEST_PATTERNS = re.compile(
    r"(××™×™× ×“×¤×•×œ× ×¡|××“×™×˜×¦×™×”|××©×”×• ××¨×’×™×¢|×©×œ×— ×œ×™ ×§×™×©×•×¨|×™×© ×œ×š ×§×™×©×•×¨\??)"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ×¤×•× ×§×¦×™×•×ª ×¢×–×¨  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def sample_links(cat: str, k: int = 2):
    subset = links_df[links_df["category"] == cat]
    if subset.empty:
        return []
    return subset.sample(n=min(k, len(subset)), replace=True)["link"].tolist()

def send_soothing_links(cat: str) -> str:
    links = sample_links(cat)
    if not links:
        return ("ğŸ˜” ×œ× ××¦××ª×™ ×›×¨×’×¢ ××©×”×• ×‘× ×•×©× ×”×–×”. ×¨×•×¦×” ×œ×‘×—×•×¨ × ×•×©× ××—×¨ "
                "××• ×¤×©×•×˜ ×œ×“×‘×¨ ×§×¦×ª? ğŸ’¬")

    intro = {
        "××“×™×˜×¦×™×”":     "ğŸ§˜â€â™€ï¸ ×”× ×” ×ª×¨×’×•×œ ××“×™×˜×¦×™×” ×©×¢×©×•×™ ×œ×”×‘×™× ××¢×˜ ×©×œ×•×•×”:\n",
        "× ×©×™××•×ª":      "ğŸŒ¬ï¸ ×‘×•×/×™ × ×ª×¨×’×œ ×™×—×“ × ×©×™××•×ª ×¢××•×§×•×ª â€“ ×”×ª×—×œ×” ×§×˜× ×” ×›××Ÿ:\n",
        "×”×¤×’×ª ××ª×—×™×": "ğŸŒ¿ ××©×”×• ×¢×“×™×Ÿ ×©×¢×•×–×¨ ×œ×©×—×¨×¨ ××ª×—×™×:\n"
    }.get(cat, "âœ¨ ××•×œ×™ ×–×” ×™×¢×–×•×¨ ×œ×š ×‘×¨×’×¢ ×–×”:\n")

    links_txt = "\n".join(f"ğŸ”— {l}" for l in links)
    return f"{intro}{links_txt}"

def needs_spontaneous_link(user_msg: str) -> bool:
    trigger = {"×œ×—×•×¥", "×œ×—×•×¦×”", "×—×¨×“", "×—×¨×“×”", "××‘×•×œ×‘×œ", "××“×•×›×", "×¢×¦×‘"}
    return any(w in user_msg for w in trigger)

def needs_link_suggestion(txt: str) -> bool:
    """×”×× ×œ×”×¦×™×¢ ×œ×™× ×§ '×¡×¤×•× ×˜× ×™' ×ª×•×š ×›×“×™ ×©×™×—×”?"""
    triggers = {"×œ×—×•×¥", "×—×¨×“", "×¢×¦×‘", "××¤×—×“", "××ª×•×—"}
    return any(w in txt for w in triggers)


def wants_link_explicit(txt: str) -> Optional[str]:
    """×‘×•×“×§ ×× ×”××©×ª××© ×××© ××‘×§×© ×§×™×©×•×¨ ×•××—×–×™×¨ ×§×˜×’×•×¨×™×” ××ª××™××” ××• None"""
    for word, cat in {
        "× ×©×™××•×ª": "× ×©×™××•×ª",
        "××“×™×˜×¦×™×”": "××“×™×˜×¦×™×”",
        "××™×™× ×“×¤×•×œ× ×¡": "××“×™×˜×¦×™×”",
        "××©×”×• ××¨×’×™×¢": "×”×¤×’×ª ××ª×—×™×",
    }.items():
        if word in txt:
            return cat
    # "×©×œ×— ×œ×™ ×§×™×©×•×¨ / ×™×© ×œ×š ×§×™×©×•×¨?"
    if "×§×™×©×•×¨" in txt:
        return random.choice(list(CATEGORIES.values()))
    return None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×§×œ×™×  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
messages_since_link = 0   # ××•× ×” ×”×•×“×¢×•×ª ××©×ª××©
msg_count = 0             # ××•× ×” ×›×œ×œ×™
chat_history = []         # ×œ×©×™×—×” ×—×•×¤×©×™×ª ×¢× GPT

system_prompt = (
    "××ª/×” ×¦'××˜×‘×•×˜ ×ª××™×›×” ×¨×’×©×™×ª ×‘×¢×‘×¨×™×ª ××“×•×‘×¨×ª, ×—××” ×•×¤×©×•×˜×”. "
    "×”××˜×¨×” ×©×œ×š ×”×™× ×œ×”×§×©×™×‘, ×œ×”×›×™×œ ×•×œ×ª××•×š ×¨×’×©×™×ª ×‘××©×ª××©/×ª â€“ ×›××• ×—×‘×¨/×” ×˜×•×‘/×”. "
    "×¢× /×™ ×‘××©×¤×˜×™× ×§×¦×¨×™×, ×‘×¨×•×¨×™×, ×‘×’×•×‘×” ×”×¢×™× ×™×™×, ×‘×œ×™ × ××•××™× ××¨×•×›×™×, "
    "×•×”×§×¤×“/×™ ×©×›×œ ×ª×©×•×‘×” ×ª×”×™×” ×§×¦×¨×” ×•×ª××¦×™×ª×™×ª. "
    "×©×œ×‘/×™ ×××•×’'×™× ×¢×“×™× ×™× ×›×©×–×” ××ª××™×, ××š ××œ ×ª×©×ª××©/×™ ×‘×œ×‘×‘×•×ª ×¦×‘×¢×•× ×™×™×. "
    "××œ ×ª×™×ª×Ÿ/×™ ××™×“×¢ ×›×œ×œ×™, ×¢×•×‘×“×•×ª ××• ×ª×©×•×‘×•×ª ×œ×©××œ×•×ª ×™×“×¢ (×›××• ×”×™×¡×˜×•×¨×™×”, ××“×¢, ×¡×“×¨×•×ª ×•×›×•'). "
    "×× ×”××©×ª××©/×ª × ×©××¢/×ª ×¢×¦×•×‘/×”, ×œ×—×•×¥/×” ××• ×‘××¦×•×§×” â€“ ×ª×‘×™×¢/×™ ×××¤×ª×™×”, ×•×ª×•×›×œ/×™ ×œ×”×¦×™×¢ ×§×™×©×•×¨ ××¨×’×™×¢ ××”×××’×¨. "
    "××œ ×ª×¢× ×”/×™ ×‘×©×¤×” ××§×¦×•×¢×™×ª ××• ×§×œ×™× ×™×ª â€“ ×“×‘×¨/×™ ×‘×¤×©×˜×•×ª, ×‘×’×•×‘×” ×”×¢×™× ×™×™×, ×›××™×œ×• ××“×•×‘×¨ ×‘×©×™×—×” ×‘×™×Ÿ ×—×‘×¨×™×. "
    "×”××™×§×•×“ ×©×œ×š ×”×•× ×”×§×©×‘×”, ×©×™×§×•×£ ×¨×’×©×™, ×—×™×–×•×§ ×¢×“×™×Ÿ ×•×”×¦×¢×” ×¢×“×™× ×” ×œ×¤×¢×•×œ×” ××¨×’×™×¢×” â€“ ×œ× ×¤×ª×¨×•× ×•×ª."
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  × ×§×•×“×ª ×§×¦×”  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.route('/')
def index():
    return send_from_directory('.', 'chat.html')
@app.post("/chat")
def chat():
    global messages_since_link
    global msg_count
    user_msg = request.json.get("message", "").strip()
    if not user_msg:
        return jsonify(response="ğŸ™‚ ×œ× ×§×™×‘×œ×ª×™ ×”×•×“×¢×”. ×¨×•×¦×” ×œ× ×¡×•×ª ×©×•×‘?")

    lower = user_msg.lower()
    msg_count += 1

    # 1) ××¦×‘ ×—×™×¨×•×
    if any(w in lower for w in DANGER_WORDS):
        return jsonify(response="ğŸ’” × ×©××¢ ×©××ª/×” ×‘××¦×•×§×” ×§×©×”. "
                                "×× × ×¤× ×”/×™ ××™×“ ×œ×¢×–×¨×” ××§×¦×•×¢×™×ª â€“ ×¢×¨\"×Ÿ â€1201 "
                                "××• ××•×§×“ ×—×™×¨×•× â€101. ×× ×™ ×¢×•×¦×¨×ª ×›××Ÿ ××ª ×”×©×™×—×”.")

    # 2) ×ª×•×›×Ÿ ×œ× ×¨×’×©×™
    if any(k in lower for k in NON_EMO_KEYWORDS):
        return jsonify(response="ğŸ“š ×× ×™ ×›××Ÿ ×œ×ª××™×›×” ×¨×’×©×™×ª ×‘×œ×‘×“. "
                                "×œ×©××œ×•×ª ×™×“×¢ ××•××œ×¥ ××§×•×¨ ××ª××™× ğŸ™‚")
    
    explicit_cat = wants_link_explicit(lower)
    if explicit_cat:
        return jsonify(response=send_soothing_links(explicit_cat))
    
    if user_msg in CATEGORIES:
        cat   = CATEGORIES[user_msg]
        links = send_soothing_links(cat)
        follow = "\n\n××™×š ×–×” ××¨×’×™×©? ×¨×•×¦×” ×œ×©×ª×£ ×¢×•×“ ×§×¦×ª? ğŸ™‚"
        return jsonify(response=links + follow)

    if user_msg == "×©×™×—×ª × ×¤×©":
        return jsonify(response="×‘×©××—×” ğŸ˜Š ××” ××¢×¡×™×§ ××•×ª×š ×›×¨×’×¢?")

    # 3) ×‘×§×©×” ×™×©×™×¨×” ×œ×§×™×©×•×¨ (×¢×´×¤ regex)
    match = LINK_REQUEST_PATTERNS.search(user_msg)
    if match:
        # ×× × ××¦× ×‘×™×˜×•×™ â€“ × ×—×¤×© ×‘-CATEGORIES ×”×ª×××”; ×‘×¨×™×¨×ª ××—×“×œ ××“×™×˜×¦×™×”
        cat = "××“×™×˜×¦×™×”"
        if "× ×©×™×" in lower:
            cat = "× ×©×™××•×ª"
        elif "××ª×—" in lower:
            cat = "×”×¤×’×ª ××ª×—×™×"
        return jsonify(response=send_soothing_links(cat))

    # 4) ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×ª×¤×¨×™×˜
    if user_msg in CATEGORIES:
        return jsonify(response=send_soothing_links(CATEGORIES[user_msg]))

    # 5) "×©×™×—×ª × ×¤×©"
    if user_msg == "×©×™×—×ª × ×¤×©":
        return jsonify(response="×‘×©××—×” ğŸ™‚ ×¡×¤×¨/×™ ×œ×™ ××” ×¢×•×‘×¨ ×¢×œ×™×š ×›×¨×’×¢?")

    # 6) ×©×™×—×” ×—×•×¤×©×™×ª  (GPT)
    chat_history.append({"role": "user", "content": user_msg})
    if len(chat_history) > 6:
        chat_history.pop(0)

    try:
        gpt_reply = client.chat.completions.create(
            model= "gpt-4o-mini",
            max_tokens = 140,
            messages   = [{"role": "system", "content": system_prompt}] + chat_history
        ).choices[0].message.content
    except Exception as e:
        print("ğŸ”´ GPT error:", e)
        gpt_reply = "ğŸ˜“ ×”×™×™×ª×” ×ª×§×œ×” ×–×× ×™×ª, × ×¡×”/×™ ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢."

    reply = gpt_reply

    # 7) ×”×¦×¢×” ×¡×¤×•× ×˜× ×™×ª ×›×œ 4 ×”×•×“×¢×•×ª ××• ×× ×”×˜×§×¡×˜ × ×©××¢ ××ª×•×—
    messages_since_link += 1
    if messages_since_link >= 4 or needs_spontaneous_link(lower):
        messages_since_link = 0    # ××™×¤×•×¡ ×”××•× ×”
        random_cat = random.choice(list(CATEGORIES.values()))
        extra_link = sample_links(random_cat, 1)
        if extra_link:
            reply += f"\n\nâœ¨ ××•×œ×™ ×–×” ×™×¢×–×•×¨ ×œ×¨×’×¢:\nğŸ”— {extra_link[0]}"

    return jsonify(response=reply)

if __name__ == "__main__":
    app.run(debug=True)